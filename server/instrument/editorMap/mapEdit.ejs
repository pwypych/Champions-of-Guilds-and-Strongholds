<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />

    <title>Map Editor</title>

    <link rel="stylesheet" href="<%= viewModel.baseurl %>/css/style.css?v=<%= viewModel.timestamp %>">
    <link rel="stylesheet" href="<%= viewModel.baseurl %>/css/ui.css?v=<%= viewModel.timestamp %>">

    <script type="text/javascript" src="<%= viewModel.baseurl %>/library/jquery-3.3.1.js"></script>

    <style>
      body {
        padding: 10px 10px 10px 30px;
        background-color: #300a24;
        color: #999;
        overflow: auto;


        image-rendering: optimizeSpeed;
        image-rendering: -moz-crisp-edges;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: -o-crisp-edges;
        image-rendering: pixelated;
        -ms-interpolation-mode: nearest-neighbor;
      }

      .board {
        margin-top: 150px;
        display: inline-block;
        white-space: nowrap;
        background-image: url('/sprite/backgroundGrass1.png');
        width: auto;
      }

      .board img {
        width: 48px;
        height: 48px;
        box-sizing: border-box;
        border-top: 1px solid #300a24;
        border-right: 1px solid #300a24;
        margin-top: -2px;
      }

      .menu {
        position: fixed;
        top: 0px;
        left: 30px;
      }

      .seperator-10 {
        margin-top: 10px;
      }

      .clearfix {
        clear: both;
      }

    </style>

  </head>

  <body>
    <div data-menu class="menu">
      <div class="seperator-20"></div>
      <a href="<%= viewModel.baseurl %>/editorMap/mapChoose">Back to map selection</a>
      <div class="seperator-20"></div>
      <img data-figure="empty" style="background-color: white;" src="<%= viewModel.baseurl %>/sprite/empty.png">
    </div>

    <div data-board class="board">
      <img src="<%= viewModel.baseurl %>/sprite/backgroundGrass1.png">
      <img src="<%= viewModel.baseurl %>/sprite/backgroundGrass1.png">
      <img src="<%= viewModel.baseurl %>/sprite/backgroundGrass1.png">
      <div class="clearfix"></div>
      <img src="<%= viewModel.baseurl %>/sprite/backgroundGrass1.png">
    </div>

    <div class="seperator-40"></div>
    <div class="seperator-40"></div>
  </body>

  <script>
    'use strict';

    // save will be done by Ajax
    // steps for undo function in localStorage
    // tools in javascript here

    const data = <%- JSON.stringify(viewModel.map) %>;
    const figures = <%- JSON.stringify(viewModel.figures) %>;
    const baseurl = '<%- viewModel.baseurl %>';
    const mapId = '<%- viewModel.mapId %>';

    const state = {};
    state.selected = 'empty';
    state.map = data.mapLayerWithStrings;

    const height = state.map.length;
    const width = state.map[0].length;

    (function init() {
      menuBoardMargin();
      figureMenuGenerate();
      figureMenuOnClick();
      boardGenerate();
      boardOnClick();
    })();

    function menuBoardMargin() {
      $(window).on('load', () => {
        const height = $('[data-menu]').outerHeight();
        $('[data-board]').css('margin-top', height + 5 + 'px');
      });
    }

    function figureMenuGenerate() {
      const $menu = $('[data-menu]');
      figures.forEach((figure) => {
        const $img = $('<img data-figure="' + figure + '" src="' + baseurl + '/sprite/' + figure + '.png">');
        $menu.append($img);
      });
    }

    function figureMenuOnClick() {
      const $imgs = $('[data-figure]');
      $('[data-figure]').on('click', (event) => {
        const $img = $(event.currentTarget);
        $imgs.css('background-color', 'transparent');
        $img.css('background-color', 'white');
        state.selected = $img.attr('data-figure');
      });
    }

    function boardGenerate() {
      const $board = $('[data-board]');
      $board.html('');

      let i = 0;
      state.map.forEach((row, y) => {
        row.forEach((figure, x) => {
          i++;
          let html = '';
          html += '<img data-square data-x="' + x + '" data-y="' + y + '" src="' + baseurl + '/sprite/' + figure + '.png">';

          if (i % width === 0) {
            html += '<div class="clearfix"></div>';
          }

          $board.append(html);
        });
      });
    }

    function boardOnClick() {
      const $imgs = $('[data-square]');
      $('[data-square]').on('click', (event) => {
        const $img = $(event.currentTarget);
        const x = $img.attr('data-x');
        const y = $img.attr('data-y');
        state.map[y][x] = state.selected;
        boardGenerate();
        boardOnClick();
        save();
      });
    }

    function save() {
      const data = { mapId: mapId, mapLayerWithStrings: state.map };
      $.post('/editorMap/mapSavePost', data, () => {});
    }

  </script>

</html>
